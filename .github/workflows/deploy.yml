name: Build & Deploy Nginx to ECS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        environment: [prod]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build & Push Docker image
      id: build-image
      env:
        ECR_REPO: ${{ secrets.ECR_REPOSITORY }}
        REGION: ${{ secrets.AWS_REGION }}
      run: |
        IMAGE_TAG=${GITHUB_SHA::7}
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        IMAGE_URI=$ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/$ECR_REPO:$IMAGE_TAG
        
        docker build -t $IMAGE_URI .
        docker push $IMAGE_URI
        
        echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

    - name: Create ECS cluster if not exists
      run: |
        aws ecs describe-clusters --clusters ${{ secrets.ECS_CLUSTER }} \
        || aws ecs create-cluster --cluster-name ${{ secrets.ECS_CLUSTER }}

    - name: Register task definition
      run: |
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        
        cat > taskdef.json <<EOF
        {
          "family": "${{ secrets.ECS_TASK_FAMILY }}",
          "networkMode": "awsvpc",
          "requiresCompatibilities": ["FARGATE"],
          "cpu": "256",
          "memory": "512",
          "executionRoleArn": "arn:aws:iam::$ACCOUNT_ID:role/${{ secrets.ECS_EXECUTION_ROLE }}",
          "containerDefinitions": [
            {
              "name": "${{ secrets.CONTAINER_NAME }}",
              "image": "${{ env.IMAGE_URI }}",
              "essential": true,
              "portMappings": [
                {
                  "containerPort": 80,
                  "protocol": "tcp"
                }
              ]
            }
          ]
        }
        EOF

        # Register and capture the new ARN
        TASK_ARN=$(aws ecs register-task-definition --cli-input-json file://taskdef.json --query 'taskDefinition.taskDefinitionArn' --output text)
        echo "TASK_ARN=$TASK_ARN" >> $GITHUB_ENV

    - name: Create or Update ECS Service
      run: |
        CLUSTER=${{ secrets.ECS_CLUSTER }}
        SERVICE=${{ secrets.ECS_SERVICE }}

        # Check if service exists
        SERVICE_STATUS=$(aws ecs describe-services --cluster $CLUSTER --services $SERVICE \
          --query "services[0].status" --output text 2>/dev/null)

        if [ "$SERVICE_STATUS" == "ACTIVE" ]; then
          echo "Service exists, updating..."
          aws ecs update-service \
            --cluster $CLUSTER \
            --service $SERVICE \
            --task-definition ${{ env.TASK_ARN }} \
            --force-new-deployment
        else
          echo "Service does not exist, creating..."
          aws ecs create-service \
            --cluster $CLUSTER \
            --service-name $SERVICE \
            --task-definition ${{ env.TASK_ARN }} \
            --desired-count 1 \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[subnet-0fdc05e397f84fbac,subnet-0df97fb0d70eb1bd4,subnet-02ac1484c20b0d1a2],securityGroups=[sg-0f3929f4b22121b24,sg-01143b7bc4fbdeec7],assignPublicIp=ENABLED}"
        fi



